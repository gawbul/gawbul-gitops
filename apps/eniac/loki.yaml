---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      chart: loki
      version: "6.x"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: monitoring
      interval: 1h
  values:
    global:
      dnsService: coredns

    loki:
      auth_enabled: false
      extraEnv:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: loki-minio-secret
              key: root-user
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: loki-minio-secret
              key: root-password
      commonConfig:
        replication_factor: 1
      schemaConfig:
        configs:
          - from: "2024-01-01"
            store: tsdb
            object_store: s3
            schema: v13
            index:
              prefix: loki_index_
              period: 24h
      storage:
        type: s3
        bucketNames:
          chunks: fnord
          ruler: ruler
          admin: admin
        s3:
          endpoint: http://loki-minio.monitoring.svc.cluster.local:9000
          access_key_id: ${MINIO_ACCESS_KEY}
          secret_access_key: ${MINIO_SECRET_KEY}
          insecure: true
          s3forcepathstyle: true

    gateway:
      nginxConfig:
        resolver: "kube-dns.kube-system.svc.cluster.local"

    resultsCache:
      enabled: false

    minio:
      enabled: true
      existingSecret: "loki-minio-secret"
      serviceAccount:
        create: true
        name: "minio-sa"
      persistence:
        storageClass: nfs-client
      volumePermissions:
        enabled: true
      securityContext:
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001

    deploymentMode: SingleBinary
    singleBinary:
      replicas: 1
      persistence:
        storageClass: nfs-client

    backend:
      replicas: 0
    read:
      replicas: 0
    write:
      replicas: 0
    ingester:
      replicas: 0
    querier:
      replicas: 0
    queryFrontend:
      replicas: 0
    queryScheduler:
      replicas: 0
    distributor:
      replicas: 0
    compactor:
      replicas: 0
    indexGateway:
      replicas: 0
    bloomCompactor:
      replicas: 0
    bloomGateway:
      replicas: 0
